System.register(["./index-legacy-DAXMxUP0.js"],(function(t,e){"use strict";var r,a,n,s;return{setters:[t=>{r=t.E,a=t.e,n=t.s,s=t.c}],execute:function(){var o="object"==typeof global&&global&&global.Object===Object&&global,i="object"==typeof self&&self&&self.Object===Object&&self,c=o||i||Function("return this")(),u=c.Symbol,h=Object.prototype,d=h.hasOwnProperty,p=h.toString,l=u?u.toStringTag:void 0,f=Object.prototype.toString,y=u?u.toStringTag:void 0;function g(t){return null==t?void 0===t?"[object Undefined]":"[object Null]":y&&y in Object(t)?function(t){var e=d.call(t,l),r=t[l];try{t[l]=void 0;var a=!0}catch(s){}var n=p.call(t);return a&&(e?t[l]=r:delete t[l]),n}(t):function(t){return f.call(t)}(t)}function b(t){return null!=t&&"object"==typeof t}var m=Array.isArray;function v(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)}function j(t){return t}function _(t){if(!v(t))return!1;var e=g(t);return"[object Function]"==e||"[object GeneratorFunction]"==e||"[object AsyncFunction]"==e||"[object Proxy]"==e}var D,A=c["__core-js_shared__"],w=(D=/[^.]+$/.exec(A&&A.keys&&A.keys.IE_PROTO||""))?"Symbol(src)_1."+D:"",O=Function.prototype.toString;function S(t){if(null!=t){try{return O.call(t)}catch(e){}try{return t+""}catch(e){}}return""}var E=/^\[object .+?Constructor\]$/,T=Function.prototype,k=Object.prototype,P=T.toString,I=k.hasOwnProperty,C=RegExp("^"+P.call(I).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function M(t){return!(!v(t)||(e=t,w&&w in e))&&(_(t)?C:E).test(S(t));var e}function $(t,e){var r=function(t,e){return null==t?void 0:t[e]}(t,e);return M(r)?r:void 0}var x,L,F,U=$(c,"WeakMap"),R=Object.create,B=function(){function t(){}return function(e){if(!v(e))return{};if(R)return R(e);t.prototype=e;var r=new t;return t.prototype=void 0,r}}(),z=Date.now,q=function(){try{var t=$(Object,"defineProperty");return t({},"",{}),t}catch(e){}}(),N=q?function(t,e){return q(t,"toString",{configurable:!0,enumerable:!1,value:(r=e,function(){return r}),writable:!0});var r}:j,V=(x=N,L=0,F=0,function(){var t=z(),e=16-(t-F);if(F=t,e>0){if(++L>=800)return arguments[0]}else L=0;return x.apply(void 0,arguments)});function G(t){return t!=t}function W(t,e){return!(null==t||!t.length)&&function(t,e,r){return e==e?function(t,e,r){for(var a=r-1,n=t.length;++a<n;)if(t[a]===e)return a;return-1}(t,e,r):function(t,e,r){for(var a=t.length,n=r+-1;++n<a;)if(e(t[n],n,t))return n;return-1}(t,G,r)}(t,e,0)>-1}var J=/^(?:0|[1-9]\d*)$/;function H(t,e){var r=typeof t;return!!(e=null==e?9007199254740991:e)&&("number"==r||"symbol"!=r&&J.test(t))&&t>-1&&t%1==0&&t<e}function K(t,e){return t===e||t!=t&&e!=e}var Z=Object.prototype.hasOwnProperty;function Q(t,e,r){var a=t[e];Z.call(t,e)&&K(a,r)&&(void 0!==r||e in t)||function(t,e,r){"__proto__"==e&&q?q(t,e,{configurable:!0,enumerable:!0,value:r,writable:!0}):t[e]=r}(t,e,r)}var X=Math.max;function Y(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=9007199254740991}function tt(t){return null!=t&&Y(t.length)&&!_(t)}var et=Object.prototype;function rt(t){var e=t&&t.constructor;return t===("function"==typeof e&&e.prototype||et)}function at(t){return b(t)&&"[object Arguments]"==g(t)}var nt=Object.prototype,st=nt.hasOwnProperty,ot=nt.propertyIsEnumerable,it=at(function(){return arguments}())?at:function(t){return b(t)&&st.call(t,"callee")&&!ot.call(t,"callee")},ct="object"==typeof t&&t&&!t.nodeType&&t,ut=ct&&"object"==typeof e&&e&&!e.nodeType&&e,ht=ut&&ut.exports===ct?c.Buffer:void 0,dt=(ht?ht.isBuffer:void 0)||function(){return!1},pt={};function lt(t){return function(e){return t(e)}}pt["[object Float32Array]"]=pt["[object Float64Array]"]=pt["[object Int8Array]"]=pt["[object Int16Array]"]=pt["[object Int32Array]"]=pt["[object Uint8Array]"]=pt["[object Uint8ClampedArray]"]=pt["[object Uint16Array]"]=pt["[object Uint32Array]"]=!0,pt["[object Arguments]"]=pt["[object Array]"]=pt["[object ArrayBuffer]"]=pt["[object Boolean]"]=pt["[object DataView]"]=pt["[object Date]"]=pt["[object Error]"]=pt["[object Function]"]=pt["[object Map]"]=pt["[object Number]"]=pt["[object Object]"]=pt["[object RegExp]"]=pt["[object Set]"]=pt["[object String]"]=pt["[object WeakMap]"]=!1;var ft="object"==typeof t&&t&&!t.nodeType&&t,yt=ft&&"object"==typeof e&&e&&!e.nodeType&&e,gt=yt&&yt.exports===ft&&o.process,bt=function(){try{var t=yt&&yt.require&&yt.require("util").types;return t||gt&&gt.binding&&gt.binding("util")}catch(e){}}(),mt=bt&&bt.isTypedArray,vt=mt?lt(mt):function(t){return b(t)&&Y(t.length)&&!!pt[g(t)]},jt=Object.prototype.hasOwnProperty;function _t(t,e){var r=m(t),a=!r&&it(t),n=!r&&!a&&dt(t),s=!r&&!a&&!n&&vt(t),o=r||a||n||s,i=o?function(t,e){for(var r=-1,a=Array(t);++r<t;)a[r]=e(r);return a}(t.length,String):[],c=i.length;for(var u in t)!jt.call(t,u)||o&&("length"==u||n&&("offset"==u||"parent"==u)||s&&("buffer"==u||"byteLength"==u||"byteOffset"==u)||H(u,c))||i.push(u);return i}function Dt(t,e){return function(r){return t(e(r))}}var At=Dt(Object.keys,Object),wt=Object.prototype.hasOwnProperty;function Ot(t){return tt(t)?_t(t):function(t){if(!rt(t))return At(t);var e=[];for(var r in Object(t))wt.call(t,r)&&"constructor"!=r&&e.push(r);return e}(t)}var St=$(Object,"create"),Et=Object.prototype.hasOwnProperty,Tt=Object.prototype.hasOwnProperty;function kt(t){var e=-1,r=null==t?0:t.length;for(this.clear();++e<r;){var a=t[e];this.set(a[0],a[1])}}function Pt(t,e){for(var r=t.length;r--;)if(K(t[r][0],e))return r;return-1}kt.prototype.clear=function(){this.__data__=St?St(null):{},this.size=0},kt.prototype.delete=function(t){var e=this.has(t)&&delete this.__data__[t];return this.size-=e?1:0,e},kt.prototype.get=function(t){var e=this.__data__;if(St){var r=e[t];return"__lodash_hash_undefined__"===r?void 0:r}return Et.call(e,t)?e[t]:void 0},kt.prototype.has=function(t){var e=this.__data__;return St?void 0!==e[t]:Tt.call(e,t)},kt.prototype.set=function(t,e){var r=this.__data__;return this.size+=this.has(t)?0:1,r[t]=St&&void 0===e?"__lodash_hash_undefined__":e,this};var It=Array.prototype.splice;function Ct(t){var e=-1,r=null==t?0:t.length;for(this.clear();++e<r;){var a=t[e];this.set(a[0],a[1])}}Ct.prototype.clear=function(){this.__data__=[],this.size=0},Ct.prototype.delete=function(t){var e=this.__data__,r=Pt(e,t);return!(r<0||(r==e.length-1?e.pop():It.call(e,r,1),--this.size,0))},Ct.prototype.get=function(t){var e=this.__data__,r=Pt(e,t);return r<0?void 0:e[r][1]},Ct.prototype.has=function(t){return Pt(this.__data__,t)>-1},Ct.prototype.set=function(t,e){var r=this.__data__,a=Pt(r,t);return a<0?(++this.size,r.push([t,e])):r[a][1]=e,this};var Mt=$(c,"Map");function $t(t,e){var r,a,n=t.__data__;return("string"==(a=typeof(r=e))||"number"==a||"symbol"==a||"boolean"==a?"__proto__"!==r:null===r)?n["string"==typeof e?"string":"hash"]:n.map}function xt(t){var e=-1,r=null==t?0:t.length;for(this.clear();++e<r;){var a=t[e];this.set(a[0],a[1])}}function Lt(t,e){for(var r=-1,a=e.length,n=t.length;++r<a;)t[n+r]=e[r];return t}xt.prototype.clear=function(){this.size=0,this.__data__={hash:new kt,map:new(Mt||Ct),string:new kt}},xt.prototype.delete=function(t){var e=$t(this,t).delete(t);return this.size-=e?1:0,e},xt.prototype.get=function(t){return $t(this,t).get(t)},xt.prototype.has=function(t){return $t(this,t).has(t)},xt.prototype.set=function(t,e){var r=$t(this,t),a=r.size;return r.set(t,e),this.size+=r.size==a?0:1,this};var Ft=u?u.isConcatSpreadable:void 0;function Ut(t){return m(t)||it(t)||!!(Ft&&t&&t[Ft])}var Rt=Dt(Object.getPrototypeOf,Object);function Bt(t){var e=this.__data__=new Ct(t);this.size=e.size}Bt.prototype.clear=function(){this.__data__=new Ct,this.size=0},Bt.prototype.delete=function(t){var e=this.__data__,r=e.delete(t);return this.size=e.size,r},Bt.prototype.get=function(t){return this.__data__.get(t)},Bt.prototype.has=function(t){return this.__data__.has(t)},Bt.prototype.set=function(t,e){var r=this.__data__;if(r instanceof Ct){var a=r.__data__;if(!Mt||a.length<199)return a.push([t,e]),this.size=++r.size,this;r=this.__data__=new xt(a)}return r.set(t,e),this.size=r.size,this};var zt="object"==typeof t&&t&&!t.nodeType&&t,qt=zt&&"object"==typeof e&&e&&!e.nodeType&&e,Nt=qt&&qt.exports===zt?c.Buffer:void 0;Nt&&Nt.allocUnsafe;var Vt=Object.prototype.propertyIsEnumerable,Gt=Object.getOwnPropertySymbols,Wt=Gt?function(t){return null==t?[]:(t=Object(t),function(t,e){for(var r=-1,a=null==t?0:t.length,n=0,s=[];++r<a;){var o=t[r];e(o,r,t)&&(s[n++]=o)}return s}(Gt(t),(function(e){return Vt.call(t,e)})))}:function(){return[]};function Jt(t){return function(t,e,r){var a=e(t);return m(t)?a:Lt(a,r(t))}(t,Ot,Wt)}var Ht=$(c,"DataView"),Kt=$(c,"Promise"),Zt=$(c,"Set"),Qt="[object Map]",Xt="[object Promise]",Yt="[object Set]",te="[object WeakMap]",ee="[object DataView]",re=S(Ht),ae=S(Mt),ne=S(Kt),se=S(Zt),oe=S(U),ie=g;(Ht&&ie(new Ht(new ArrayBuffer(1)))!=ee||Mt&&ie(new Mt)!=Qt||Kt&&ie(Kt.resolve())!=Xt||Zt&&ie(new Zt)!=Yt||U&&ie(new U)!=te)&&(ie=function(t){var e=g(t),r="[object Object]"==e?t.constructor:void 0,a=r?S(r):"";if(a)switch(a){case re:return ee;case ae:return Qt;case ne:return Xt;case se:return Yt;case oe:return te}return e});var ce=Object.prototype.hasOwnProperty,ue=c.Uint8Array;function he(t){var e=new t.constructor(t.byteLength);return new ue(e).set(new ue(t)),e}var de=/\w*$/,pe=u?u.prototype:void 0,le=pe?pe.valueOf:void 0;function fe(t,e,r){var a,n,s,o,i,c=t.constructor;switch(e){case"[object ArrayBuffer]":return he(t);case"[object Boolean]":case"[object Date]":return new c(+t);case"[object DataView]":return i=he((o=t).buffer),new o.constructor(i,o.byteOffset,o.byteLength);case"[object Float32Array]":case"[object Float64Array]":case"[object Int8Array]":case"[object Int16Array]":case"[object Int32Array]":case"[object Uint8Array]":case"[object Uint8ClampedArray]":case"[object Uint16Array]":case"[object Uint32Array]":return function(t){var e=he(t.buffer);return new t.constructor(e,t.byteOffset,t.length)}(t);case"[object Map]":case"[object Set]":return new c;case"[object Number]":case"[object String]":return new c(t);case"[object RegExp]":return(s=new(n=t).constructor(n.source,de.exec(n))).lastIndex=n.lastIndex,s;case"[object Symbol]":return a=t,le?Object(le.call(a)):{}}}var ye=bt&&bt.isMap,ge=ye?lt(ye):function(t){return b(t)&&"[object Map]"==ie(t)},be=bt&&bt.isSet,me=be?lt(be):function(t){return b(t)&&"[object Set]"==ie(t)},ve="[object Arguments]",je="[object Function]",_e="[object Object]",De={};function Ae(t,e,r,a,n,s){var o;if(void 0!==o)return o;if(!v(t))return t;var i=m(t);if(i)o=function(t){var e=t.length,r=new t.constructor(e);return e&&"string"==typeof t[0]&&ce.call(t,"index")&&(r.index=t.index,r.input=t.input),r}(t);else{var c=ie(t),u=c==je||"[object GeneratorFunction]"==c;if(dt(t))return t.slice();if(c==_e||c==ve||u&&!n)o=u?{}:function(t){return"function"!=typeof t.constructor||rt(t)?{}:B(Rt(t))}(t);else{if(!De[c])return n?t:{};o=fe(t,c)}}s||(s=new Bt);var h=s.get(t);if(h)return h;s.set(t,o),me(t)?t.forEach((function(a){o.add(Ae(a,e,r,0,t,s))})):ge(t)&&t.forEach((function(a,n){o.set(n,Ae(a,e,r,0,t,s))}));var d=i?void 0:Jt(t);return function(t,e){for(var r=-1,a=null==t?0:t.length;++r<a&&!1!==e(t[r],r,t););}(d||t,(function(a,n){d&&(a=t[n=a]),Q(o,n,Ae(a,e,r,0,t,s))})),o}function we(t){return Ae(t,5)}function Oe(t){var e=-1,r=null==t?0:t.length;for(this.__data__=new xt;++e<r;)this.add(t[e])}function Se(t,e){return t.has(e)}function Ee(t){var e=-1,r=Array(t.size);return t.forEach((function(t){r[++e]=t})),r}function Te(t){return b(t)&&tt(t)}De[ve]=De["[object Array]"]=De["[object ArrayBuffer]"]=De["[object DataView]"]=De["[object Boolean]"]=De["[object Date]"]=De["[object Float32Array]"]=De["[object Float64Array]"]=De["[object Int8Array]"]=De["[object Int16Array]"]=De["[object Int32Array]"]=De["[object Map]"]=De["[object Number]"]=De[_e]=De["[object RegExp]"]=De["[object Set]"]=De["[object String]"]=De["[object Symbol]"]=De["[object Uint8Array]"]=De["[object Uint8ClampedArray]"]=De["[object Uint16Array]"]=De["[object Uint32Array]"]=!0,De["[object Error]"]=De[je]=De["[object WeakMap]"]=!1,Oe.prototype.add=Oe.prototype.push=function(t){return this.__data__.set(t,"__lodash_hash_undefined__"),this},Oe.prototype.has=function(t){return this.__data__.has(t)};var ke=Zt&&1/Ee(new Zt([,-0]))[1]==1/0?function(t){return new Zt(t)}:function(){};!function(t,e){V(function(t,e,r){return e=X(void 0===e?t.length-1:e,0),function(){for(var a=arguments,n=-1,s=X(a.length-e,0),o=Array(s);++n<s;)o[n]=a[e+n];n=-1;for(var i=Array(e+1);++n<e;)i[n]=a[n];return i[e]=r(o),function(t,e,r){switch(r.length){case 0:return t.call(e);case 1:return t.call(e,r[0]);case 2:return t.call(e,r[0],r[1]);case 3:return t.call(e,r[0],r[1],r[2])}return t.apply(e,r)}(t,this,i)}}(t,e,j),t+"")}((function(t){return function(t,e,r){var a=-1,n=W,s=t.length,o=!0,i=[],c=i;if(s>=200){var u=ke(t);if(u)return Ee(u);o=!1,n=Se,c=new Oe}else c=i;t:for(;++a<s;){var h=t[a],d=h;if(h=0!==h?h:0,o&&d==d){for(var p=c.length;p--;)if(c[p]===d)continue t;i.push(h)}else n(c,d,r)||(c!==i&&c.push(d),i.push(h))}return i}(function(t,e,r,a,n){var s=-1,o=t.length;for(r||(r=Ut),n||(n=[]);++s<o;){var i=t[s];r(i)&&Lt(n,i)}return n}(t,0,Te))}));class Pe{}class Ie extends Pe{data={};event=(()=>new a.EventEmitter)();constructor(t){super(),this.data=t}update(t,e){e?He(e,t,this.data):this.data=t;const r={updateData:t,path:e??""};e&&this.event.emit(e,r),this.event.emit("",r)}on(t,e){this.event.on(t,e)}off(t,e){this.event.off(t,e)}getData(t){return t?Je(t,this.data):this.data}destroy(){}}class Ce extends r{isInit=!1;app;mockData;#t="base";#e;#r;#a;#n=[];#s=[];constructor(t){super(),this.#e=t.schema.id,this.#r=t.schema,this.app=t.app,this.setFields(t.schema.fields),this.setMethods(t.schema.methods||[]);let e=t.initialData;const r=t.ObservedDataClass||Ie;if("editor"===this.app.platform)this.mockData=t.schema.mocks?.find((t=>t.useInEditor))?.data||this.getDefaultData(),e=we(this.mockData);else if("boolean"==typeof t.useMock&&t.useMock)this.mockData=t.schema.mocks?.find((t=>t.enable))?.data,e=this.mockData||this.getDefaultData();else{if(t.initialData)return this.#a=new r(t.initialData??{}),void(this.isInit=!0);e=this.getDefaultData()}this.#a=new r(e??{})}get id(){return this.#e}get type(){return this.#t}get schema(){return this.#r}get fields(){return this.#n}get methods(){return this.#s}setFields(t){this.#n=t}setMethods(t){this.#s=t}get data(){return this.#a.getData("")}setData(t,e){this.#a.update(t,e);const r={updateData:t,path:e};this.emit("change",r)}setValue(t,e){return this.setData(e,t)}onDataChange(t,e){this.#a.on(t,e)}offDataChange(t,e){this.#a.off(t,e)}getDefaultData(){return Xe(this.#n)}async init(){this.isInit=!0}destroy(){this.#n=[],this.removeAllListeners(),this.#a.destroy()}}const Me=t=>Object.entries(t).reduce(((t,[e,r])=>{let a=r;return"object"==typeof r&&(a=JSON.stringify(r)),void 0!==r?`${t}${t?"&":""}${globalThis.encodeURIComponent(e)}=${globalThis.encodeURIComponent(`${a}`)}`:t}),""),$e=async t=>{const{url:e,method:r="GET",headers:a={},params:n={},data:s={},...o}=t,i=Me(n);let c=JSON.stringify(s);return a["Content-Type"]?.includes("application/x-www-form-urlencoded")&&(c=Me(s)),(await globalThis.fetch(i?`${e}?${i}`:e,{method:r,headers:a,body:"GET"===r?void 0:c,...o})).json()},xe=new Map,Le=(t,e)=>{let r=!0;for(const{op:n,value:s,range:o,field:i}of t){const[t,...c]=i,u=e[t];if(!u||!c.length)break;try{const t=Je(c.join("."),u);if(!Qe(n,t,s,o)){r=!1;break}}catch(a){console.warn(a)}}return r},Fe=(t,e)=>{if(!t[Ve]||!Array.isArray(t[Ve])||!t[Ve].length)return!0;for(const{cond:r}of t[Ve])if(r&&Le(r,e))return!0;return!1},Ue=(t,e,r=[],a={})=>{const n={...a,[e]:{}};let s=we(a[e]),o=n[e];return r.forEach(((e,a)=>{Object.assign(o,s),a!==r.length-1?(Array.isArray(s[e])&&(s[e]={},o[e]={}),s=s[e],o=o[e]):o[e]=t})),n},Re=(t,e)=>t.replaceAll(tr,((t,r)=>{try{return Je(r,e)}catch(a){return t}})),Be=(t,e)=>"string"==typeof t?Re(t,e):t?.isBindDataSource&&t.dataSourceId?e[t.dataSourceId]:t?.isBindDataSourceField&&t.dataSourceId&&"string"==typeof t.template?Re(t.template,e[t.dataSourceId]):Array.isArray(t)&&"string"==typeof t[0]?((t,e)=>{const[r,...a]=t,n=r.indexOf(Ye);if(n>-1){const o=e[r.substring(n+Ye.length)];if(!o)return t;try{return Je(a.join("."),o)}catch(s){return t}}return t})(t,e):t,ze=({compile:t,dsId:e,item:r,deps:a,condDeps:n,inEditor:s,ctxData:o})=>{const{items:i,...c}=r,u=we(c);return n[c.id]?.keys.length&&!s&&(u.condResult=Fe(c,o)),Array.isArray(i)&&i.length?u.items=i.map((r=>ze({compile:t,dsId:e,item:r,deps:a,condDeps:n,inEditor:s,ctxData:o}))):i&&(u.items=i),a[u.id]?.keys.length?Ze(t,u,{[e]:a},e):u};class qe extends r{static dataSourceClassMap=(()=>new Map)();static ObservedDataClass=(()=>Ie)();static register(t,e){qe.dataSourceClassMap.set(t,e)}static getDataSourceClass(t){return qe.dataSourceClassMap.get(t)}static registerObservedData(t){qe.ObservedDataClass=t}app;dataSourceMap=(()=>new Map)();data={};useMock=!1;constructor({app:t,useMock:e,initialData:r}){super(),this.app=t,this.useMock=e,r&&(this.data=r),t.dsl?.dataSources?.forEach((t=>{this.addDataSource(t)}));const a=Array.from(this.dataSourceMap);"function"==typeof Promise.allSettled?Promise.allSettled(a.map((([,t])=>this.init(t)))).then((t=>{const e={},r={};t.forEach(((t,n)=>{const s=a[n][0];"fulfilled"===t.status?this.data[s]?e[s]=this.data[s]:delete e[s]:"rejected"===t.status&&(delete e[s],r[s]=t.reason)})),this.emit("init",e,r)})):Promise.all(a.map((([,t])=>this.init(t)))).then((()=>{this.emit("init",this.data)})).catch((()=>{this.emit("init",this.data)}))}async init(t){if(!(t.isInit||this.app.jsEngine&&t.schema.disabledInitInJsEngine?.includes(this.app.jsEngine))){for(const e of t.methods){if("function"!=typeof e.content)return;"beforeInit"===e.timing&&await e.content({params:{},dataSource:t,app:this.app})}await t.init();for(const e of t.methods){if("function"!=typeof e.content)return;"afterInit"===e.timing&&await e.content({params:{},dataSource:t,app:this.app})}}}get(t){return this.dataSourceMap.get(t)}async addDataSource(t){if(!t)return;const e=new(qe.dataSourceClassMap.get(t.type)||Ce)({app:this.app,schema:t,request:this.app.request,useMock:this.useMock,initialData:this.data[t.id],ObservedDataClass:qe.ObservedDataClass});this.dataSourceMap.set(t.id,e),this.data[e.id]=e.data,e.on("change",(t=>{this.setData(e,t)}))}setData(t,e){this.data[t.id]=t.data,this.emit("change",t.id,e)}removeDataSource(t){this.get(t)?.destroy(),delete this.data[t],this.dataSourceMap.delete(t)}updateSchema(t){t.forEach((t=>{if(!this.get(t.id))return;this.removeDataSource(t.id),this.addDataSource(t);const e=this.get(t.id);e&&this.init(e)}))}compiledNode({items:t,...e},r,a=!1){const n=we(e);return t&&(n.items=Array.isArray(t)&&a?t.map((t=>this.compiledNode(t,r,a))):t),!1===e.condResult||!1===e.visible?n:Ze((t=>Be(t,this.data)),n,this.app.dsl?.dataSourceDeps||{},r)}compliedConds(t){return Fe(t,this.data)}compliedIteratorItemConds(t,e,r=[]){const[a,...n]=r,s=this.get(a);if(!s)return!0;const o=Ue(t,s.id,n,this.data);return Fe(e,o)}compliedIteratorItems(t,e,r=[]){const[a,...n]=r,s=this.get(a);if(!s)return e;const o="editor"===this.app.platform,i=Ue(t,s.id,n,this.data),{deps:c={},condDeps:u={}}=((t,e,r)=>{let a;if(r){const r=[];e.forEach((t=>{er(t,(t=>{r.push(t.id)}))})),a=`${t.id}:${r.join(":")}`}else a=`${t.id}:${e.map((t=>t.id)).join(":")}`;if(xe.has(a))return xe.get(a);const n=new cr;n.addTarget(new ar({id:t.id,type:"data-source",isTarget:(e,r)=>!`${e}`.includes(Ke)&&sr(t,e,r,!0)})),n.addTarget(new ar({id:t.id,type:"cond",isTarget:(e,r)=>or(t,e,r,!0)})),n.collect(e,{},!0);const{deps:s}=n.getTarget(t.id,"data-source"),{deps:o}=n.getTarget(t.id,"cond"),i={deps:s,condDeps:o};return xe.set(a,i),i})(s.schema,e,o);return Object.keys(c).length||Object.keys(u).length?e.map((t=>ze({compile:t=>Be(t,i),dsId:s.id,item:t,deps:c,condDeps:u,inEditor:o,ctxData:i}))):e}destroy(){this.removeAllListeners(),this.data={},this.dataSourceMap.forEach((t=>{t.destroy()})),this.dataSourceMap.clear()}onDataChange(t,e,r){return this.get(t)?.onDataChange(e,r)}offDataChange(t,e,r){return this.get(t)?.offDataChange(e,r)}}qe.register("http",class extends Ce{isLoading=!1;error;httpOptions;#o;#i=[];#c=[];#t="http";constructor(t){const{options:e}=t.schema;super(t),this.httpOptions=e,"function"==typeof t.request?this.#o=t.request:"function"==typeof globalThis.fetch&&(this.#o=$e),this.methods.forEach((t=>{"function"==typeof t.content&&("beforeRequest"===t.timing&&this.#i.push(t.content),"afterRequest"===t.timing&&this.#c.push(t.content))}))}get type(){return this.#t}async init(){this.schema.autoFetch&&await this.request(),super.init()}async request(t={}){this.isLoading=!0;const{url:e,params:r,data:a,headers:n,...s}=this.httpOptions;let o={url:"function"==typeof e?e({app:this.app,dataSource:this}):e,params:"function"==typeof r?r({app:this.app,dataSource:this}):r,data:"function"==typeof a?a({app:this.app,dataSource:this}):a,headers:"function"==typeof n?n({app:this.app,dataSource:this}):n,...s,...t};try{for(const t of this.#i)await t({options:o,params:{},dataSource:this,app:this.app});if("function"==typeof this.schema.beforeRequest&&(o=await this.schema.beforeRequest(o,{app:this.app,dataSource:this})),this.mockData)this.setData(this.mockData);else{let t=await(this.#o?.(o));for(const e of this.#c)await e({res:t,options:o,params:{},dataSource:this,app:this.app});if("function"==typeof this.schema.afterResponse&&(t=await this.schema.afterResponse(t,{app:this.app,dataSource:this,options:o})),this.schema.responseOptions?.dataPath){const e=Je(this.schema.responseOptions.dataPath,t);this.setData(e)}else this.setData(t)}this.error=void 0}catch(i){this.error={msg:i.message},this.emit("error",i)}this.isLoading=!1}get(t){return this.request({...t,method:"GET"})}post(t){return this.request({...t,method:"POST"})}});var Ne=t("c",(t=>(t.CONTAINER="container",t.PAGE="page",t.ROOT="app",t.PAGE_FRAGMENT="page-fragment",t))(Ne||{}));const Ve="displayConds",Ge=(t("b",(()=>{const t=new Map;return(e,r,a=globalThis.document)=>{let n=t.get(a);if(n||(n=new Map,t.set(a,n)),n.get(e))return n.get(e);const s=new Promise(((t,n)=>{const s=a.createElement("script");s.type="text/javascript",r&&(s.crossOrigin=r),s.src=e,a.body.appendChild(s),s.onload=()=>{t()},s.onerror=()=>{n(new Error("加载失败"))},setTimeout((()=>{n(new Error("timeout"))}),6e4)})).catch((t=>{throw n.delete(e),t}));return n.set(e,s),n.get(e)}})()),t("a",(()=>{const t=new Map;return(e,r=globalThis.document)=>{let a=t.get(r);if(a||(a=new Map,t.set(r,a)),a.get(e))return a.get(e);const n=new Promise(((t,a)=>{const n=r.createElement("link");n.rel="stylesheet",n.href=e,r.head.appendChild(n),n.onload=()=>{t()},n.onerror=()=>{a(new Error("加载失败"))},setTimeout((()=>{a(new Error("timeout"))}),6e4)})).catch((t=>{throw a.delete(e),t}));return a.set(e,n),a.get(e)}})()),t("t",((t="")=>t.replace(/\B([A-Z])/g,"-$1").toLowerCase())),t=>"[object Object]"===Object.prototype.toString.call(t)),We=t=>`${t}`.replaceAll(/\[(\d+)\]/g,".$1").split("."),Je=(t="",e={})=>(Array.isArray(t)?t:We(t)).reduce(((r,a)=>{if(Ge(r))return r[a];if(Array.isArray(r)&&/^\d*$/.test(`${a}`))return r[a];throw new Error(`${e}中不存在${t}`)}),e),He=(t,e,r={})=>n(r,t,e),Ke="__tmagic__",Ze=(t("I","__tmagic__dslNode"),(t,e,r={},a)=>{let n=[];if(a){const t=r[a];n=t?.[e.id].keys||[]}else n=((t={},e)=>Array.from(Object.values(t).reduce(((t,r)=>((r[e]?.keys||[]).forEach((e=>t.add(e))),t)),new Set)))(r,e.id);return n.forEach((r=>{const a=We(r),n=a.map(((t,e)=>e<a.length-1?t:`${Ke}${t}`));let s,o=Je(n,e);if(void 0===o)try{const t=Je(r,e);He(n.join("."),t,e),o=t}catch(i){return void console.warn(i)}try{s=t(o)}catch(i){console.error(i),s=""}He(r,s,e)})),e}),Qe=(t,e,r,a=[])=>{switch("string"==typeof e&&void 0===r&&(r=""),t){case"is":case"=":return e===r;case"not":case"!=":return e!==r;case">":return e>r;case">=":return e>=r;case"<":return e<r;case"<=":return e<=r;case"between":return a.length>1&&e>=a[0]&&e<=a[1];case"not_between":return a.length<2||e<a[0]||e>a[1];case"include":return e?.includes?.(r);case"not_include":return void 0===e||!e.includes?.(r)}return!1},Xe=t=>{const e={},r={string:void 0,object:{},array:[],boolean:void 0,number:void 0,null:null,any:void 0};return t.forEach((t=>{if(void 0===t.defaultValue)"object"!==t.type?t.type?e[t.name]=r[t.type]:e[t.name]=void 0:e[t.name]=t.fields?Xe(t.fields):r.object;else{if("array"===t.type&&!Array.isArray(t.defaultValue))return void(e[t.name]=r.array);if("object"===t.type&&!Ge(t.defaultValue)){if("string"==typeof t.defaultValue){try{e[t.name]=JSON.parse(t.defaultValue)}catch(a){e[t.name]=r.object}return}return void(e[t.name]=r.object)}e[t.name]=s(t.defaultValue)}})),e},Ye="ds-field::",tr=/\$\{([\s\S]+?)\}/g,er=(t,e,r=[])=>{e(t,r),Array.isArray(t.items)&&t.items.length&&(r.push(t),t.items.forEach((t=>{er(t,e,[...r])})))};var rr=(t=>(t.DEFAULT="default",t.CODE_BLOCK="code-block",t.DATA_SOURCE="data-source",t.DATA_SOURCE_METHOD="data-source-method",t.DATA_SOURCE_COND="data-source-cond",t))(rr||{});class ar{isTarget;id;name;type=(()=>rr.DEFAULT)();deps={};isCollectByDefault;constructor(t){this.isTarget=t.isTarget,this.id=t.id,this.name=t.name,this.isCollectByDefault=t.isCollectByDefault??!0,t.type&&(this.type=t.type),t.initialDeps&&(this.deps=t.initialDeps)}updateDep({id:t,name:e,key:r,data:a}){const n=this.deps[t]||{name:e,keys:[]};n.name=e,n.data=a,this.deps[t]=n,-1===n.keys.indexOf(r)&&n.keys.push(r)}removeDep(t,e){if(void 0===t)return void Object.keys(this.deps).forEach((t=>{delete this.deps[t]}));const r=this.deps[t];if(r)if(e){const a=r.keys.indexOf(e);r.keys.splice(a,1),0===r.keys.length&&delete this.deps[t]}else delete this.deps[t]}hasDep(t,e){const r=this.deps[t];return Boolean(r?.keys.find((t=>t===e)))}destroy(){this.deps={}}}const nr=(t,e)=>{let r=e;return t.some(((e,a)=>{const n=r.find((({name:t})=>t===e));return r=n?.fields||[],n&&"array"===n.type&&/^(?!\d+$).*$/.test(`${t[a+1]}`)&&a<t.length-1}))},sr=(t,e,r,a=!1)=>{if(`${e}`.startsWith(Ve))return!1;if("string"==typeof r)return((t,e,r=!1)=>{const a=t.match(tr)||[];if(a.length<=0)return!1;const n=[],s=[];return a.forEach((t=>{const r=t.substring(2,t.length-1),a=We(r),o=a.shift();o&&o===e.id&&(nr(a,e.fields)?n.push(t):s.push(t))})),r?n.length>0:s.length>0})(r,t,a);if(Ge(r)&&r?.isBindDataSource&&r.dataSourceId&&r.dataSourceId===t.id)return!0;if(((t,e)=>t?.isBindDataSourceField&&t.dataSourceId&&t.dataSourceId===e&&"string"==typeof t.template)(r,t.id))return!0;if(((t,e)=>{if(!Array.isArray(t)||"string"!=typeof t[0])return!1;const[r]=t,a=r.indexOf(Ye);return-1!==a&&r.substring(a+Ye.length)===e})(r,t.id)){const[,...e]=r,n=nr(e,t.fields);return a?n:!n}return!1},or=(t,e,r,a=!1)=>{if(!Array.isArray(r)||!t)return!1;const[n,...s]=r;if(n!==t.id||!`${e}`.startsWith(Ve))return!1;if(t.fields?.find((t=>t.name===s[0]))){const e=nr(s,t.fields);return a?e:!e}return!1},ir=(t,e,r)=>{Object.values(t).forEach((t=>{Object.values(t).forEach((t=>{r&&t.type!==r||e(t)}))}))};class cr{targetsList={};childrenProp="items";idProp="id";nameProp="name";constructor(t){t?.initialTargets&&(this.targetsList=t.initialTargets),t?.childrenProp&&(this.childrenProp=t.childrenProp)}getTargetsList(){return this.targetsList}getTargets(t=rr.DEFAULT){return this.targetsList[t]||{}}addTarget(t){const e=this.getTargets(t.type)||{};this.targetsList[t.type]=e,e[t.id]=t}getTarget(t,e=rr.DEFAULT){return this.getTargets(e)[t]}hasTarget(t,e=rr.DEFAULT){return Boolean(this.getTarget(t,e))}hasSpecifiedTypeTarget(t=rr.DEFAULT){return Object.keys(this.getTargets(t)).length>0}removeTarget(t,e=rr.DEFAULT){const r=this.getTargets(e);r[t]&&(r[t].destroy(),delete r[t])}removeTargets(t=rr.DEFAULT){const e=this.targetsList[t];if(e){for(const t of Object.values(e))t.destroy();delete this.targetsList[t]}}clearTargets(){Object.keys(this.targetsList).forEach((t=>{delete this.targetsList[t]}))}collect(t,e={},r=!1,a){this.collectByCallback(t,a,(({node:t,target:a})=>{this.removeTargetDep(a,t),this.collectItem(t,a,e,r)}))}collectByCallback(t,e,r){ir(this.targetsList,(a=>{(e||a.isCollectByDefault)&&t.forEach((t=>{r({node:t,target:a})}))}),e)}clear(t,e){let{targetsList:r}=this;e&&(r={[e]:this.getTargets(e)});const a=[];ir(r,(e=>{t?t.forEach((t=>{e.removeDep(t[this.idProp]),Array.isArray(t[this.childrenProp])&&t[this.childrenProp].length&&!a.includes(t[this.idProp])&&(a.push(t[this.idProp]),this.clear(t[this.childrenProp]))})):e.removeDep()}))}clearByType(t,e){this.clear(e,t)}collectItem(t,e,r={},a=!1){const n=(s,o="")=>{const i=(s,i)=>{const c=s===this.childrenProp,u=o?`${o}.${s}`:s;e.isTarget(u,i)?e.updateDep({id:t[this.idProp],name:`${t[this.nameProp]||t[this.idProp]}`,data:r,key:u}):!c&&Array.isArray(i)?i.forEach(((t,e)=>{Ge(t)&&n(t,`${u}[${e}]`)})):Ge(i)&&n(i,u),c&&a&&Array.isArray(i)&&i.forEach((t=>{this.collectItem(t,e,r,a)}))};Object.entries(s).forEach((([t,e])=>{void 0!==e&&""!==e&&i(t,e)}))};n(t)}removeTargetDep(t,e,r){t.removeDep(e[this.idProp],r),void 0===r&&Array.isArray(e[this.childrenProp])&&e[this.childrenProp].length&&e[this.childrenProp].forEach((e=>{this.removeTargetDep(t,e,r)}))}}}}}));
//# sourceMappingURL=tmagic-dep-legacy-zBALjrD7.js.map
